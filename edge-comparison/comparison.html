<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Detection Comparison - WASM vs JavaScript</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-section {
            text-align: center;
            margin-bottom: 30px;
        }
        input[type="file"] {
            padding: 10px;
            margin: 10px;
            border: 2px solid #3498db;
            border-radius: 5px;
            cursor: pointer;
        }
        button {
            padding: 12px 30px;
            margin: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .wasm-btn {
            background-color: #27ae60;
            color: white;
        }
        .wasm-btn:hover {
            background-color: #229954;
        }
        .js-btn {
            background-color: #e74c3c;
            color: white;
        }
        .js-btn:hover {
            background-color: #c0392b;
        }
        .both-btn {
            background-color: #3498db;
            color: white;
        }
        .both-btn:hover {
            background-color: #2980b9;
        }
        .canvas-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .canvas-wrapper {
            text-align: center;
        }
        canvas {
            border: 2px solid #3498db;
            border-radius: 5px;
            max-width: 100%;
            height: auto;
        }
        h3 {
            color: #2c3e50;
            margin-top: 10px;
        }
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9em;
            margin-left: 10px;
            color: white;
        }
        .badge-wasm {
            background-color: #27ae60;
        }
        .badge-js {
            background-color: #e74c3c;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-card.wasm {
            background-color: #d5f4e6;
            border-left: 4px solid #27ae60;
        }
        .stat-card.js {
            background-color: #fadbd8;
            border-left: 4px solid #e74c3c;
        }
        .stat-card.comparison {
            background-color: #ebf5fb;
            border-left: 4px solid #3498db;
        }
        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }
        .speedup {
            font-size: 1.2em;
            color: #27ae60;
            font-weight: bold;
            margin-top: 10px;
        }
        .info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚡ Edge Detection Performance Comparison</h1>
        
        <div class="upload-section">
            <input type="file" id="imageUpload" accept="image/*">
            <p>Upload an image to compare WebAssembly vs JavaScript performance</p>
            <div>
                <button class="wasm-btn" id="wasmBtn">Run WASM Only</button>
                <button class="js-btn" id="jsBtn">Run JavaScript Only</button>
                <button class="both-btn" id="bothBtn">Compare Both</button>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-wrapper">
                <h3>Original Image</h3>
                <canvas id="originalCanvas"></canvas>
            </div>
            <div class="canvas-wrapper">
                <h3>WebAssembly <span class="badge badge-wasm">WASM</span></h3>
                <canvas id="wasmCanvas"></canvas>
            </div>
            <div class="canvas-wrapper">
                <h3>JavaScript <span class="badge badge-js">JS</span></h3>
                <canvas id="jsCanvas"></canvas>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card wasm">
                <div class="stat-label">WebAssembly Time</div>
                <div class="stat-value" id="wasmTime">-</div>
            </div>
            <div class="stat-card js">
                <div class="stat-label">JavaScript Time</div>
                <div class="stat-value" id="jsTime">-</div>
            </div>
            <div class="stat-card comparison">
                <div class="stat-label">Performance</div>
                <div class="stat-value" id="speedup">-</div>
                <div class="speedup" id="speedupText"></div>
            </div>
        </div>

        <div class="info">
            <p id="status">Ready to compare edge detection algorithms...</p>
        </div>
    </div>

    <script>
        var Module = {
            onRuntimeInitialized: function() {
                console.log('WebAssembly module loaded and ready!');
            }
        };
    </script>
    <script src="demo.js"></script>
    <script>
        const fileInput = document.getElementById('imageUpload');
        const wasmBtn = document.getElementById('wasmBtn');
        const jsBtn = document.getElementById('jsBtn');
        const bothBtn = document.getElementById('bothBtn');
        const originalCanvas = document.getElementById('originalCanvas');
        const wasmCanvas = document.getElementById('wasmCanvas');
        const jsCanvas = document.getElementById('jsCanvas');
        const originalCtx = originalCanvas.getContext('2d');
        const wasmCtx = wasmCanvas.getContext('2d');
        const jsCtx = jsCanvas.getContext('2d');
        const statusText = document.getElementById('status');
        const wasmTimeText = document.getElementById('wasmTime');
        const jsTimeText = document.getElementById('jsTime');
        const speedupText = document.getElementById('speedup');
        const speedupDescText = document.getElementById('speedupText');

        let currentImage = null;
        let originalImageData = null;

        // JavaScript edge detection implementation
        function edgeDetectionJS(imageData, width, height) {
            const data = imageData.data;
            const output = new Uint8ClampedArray(data.length);
            
            const sobelX = [
                [-1, 0, 1],
                [-2, 0, 2],
                [-1, 0, 1]
            ];
            
            const sobelY = [
                [-1, -2, -1],
                [0, 0, 0],
                [1, 2, 1]
            ];
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    let gx = 0, gy = 0;
                    
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const idx = ((y + ky) * width + (x + kx)) * 4;
                            const gray = data[idx];
                            
                            gx += gray * sobelX[ky + 1][kx + 1];
                            gy += gray * sobelY[ky + 1][kx + 1];
                        }
                    }
                    
                    const magnitude = Math.sqrt(gx * gx + gy * gy);
                    const value = Math.min(255, magnitude);
                    
                    const outIdx = (y * width + x) * 4;
                    output[outIdx] = value;
                    output[outIdx + 1] = value;
                    output[outIdx + 2] = value;
                    output[outIdx + 3] = 255;
                }
            }
            
            return output;
        }

        function runWASMEdgeDetection() {
            if (!originalImageData) return null;

            const imageData = new ImageData(
                new Uint8ClampedArray(originalImageData.data),
                originalImageData.width,
                originalImageData.height
            );
            const data = imageData.data;

            const numBytes = data.length;
            const ptr = Module._malloc(numBytes);
            HEAPU8.set(data, ptr);

            const startTime = performance.now();
            Module._edge_detection(ptr, currentImage.width, currentImage.height);
            const endTime = performance.now();

            const processedData = HEAPU8.slice(ptr, ptr + numBytes);
            Module._free(ptr);

            const processedImageData = new ImageData(
                new Uint8ClampedArray(processedData),
                currentImage.width,
                currentImage.height
            );
            wasmCtx.putImageData(processedImageData, 0, 0);

            return endTime - startTime;
        }

        function runJSEdgeDetection() {
            if (!originalImageData) return null;

            const imageData = new ImageData(
                new Uint8ClampedArray(originalImageData.data),
                originalImageData.width,
                originalImageData.height
            );

            const startTime = performance.now();
            const processedData = edgeDetectionJS(imageData, currentImage.width, currentImage.height);
            const endTime = performance.now();

            const processedImageData = new ImageData(processedData, currentImage.width, currentImage.height);
            jsCtx.putImageData(processedImageData, 0, 0);

            return endTime - startTime;
        }

        function updateStats(wasmTime, jsTime) {
            if (wasmTime !== null) {
                wasmTimeText.textContent = `${wasmTime.toFixed(2)} ms`;
            }
            if (jsTime !== null) {
                jsTimeText.textContent = `${jsTime.toFixed(2)} ms`;
            }
            if (wasmTime !== null && jsTime !== null) {
                const speedup = (jsTime / wasmTime).toFixed(2);
                speedupText.textContent = `${speedup}x`;
                speedupDescText.textContent = `WASM is ${speedup}x faster`;
            }
        }

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            statusText.textContent = 'Loading image...';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    
                    originalCanvas.width = img.width;
                    originalCanvas.height = img.height;
                    wasmCanvas.width = img.width;
                    wasmCanvas.height = img.height;
                    jsCanvas.width = img.width;
                    jsCanvas.height = img.height;

                    originalCtx.drawImage(img, 0, 0);
                    originalImageData = originalCtx.getImageData(0, 0, img.width, img.height);

                    wasmTimeText.textContent = '-';
                    jsTimeText.textContent = '-';
                    speedupText.textContent = '-';
                    speedupDescText.textContent = '';

                    statusText.textContent = 'Image loaded! Click a button to run edge detection.';
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        wasmBtn.addEventListener('click', function() {
            if (!currentImage) return;
            statusText.textContent = 'Running WebAssembly edge detection...';
            setTimeout(() => {
                const time = runWASMEdgeDetection();
                updateStats(time, null);
                statusText.textContent = '✓ WebAssembly edge detection completed!';
            }, 10);
        });

        jsBtn.addEventListener('click', function() {
            if (!currentImage) return;
            statusText.textContent = 'Running JavaScript edge detection...';
            setTimeout(() => {
                const time = runJSEdgeDetection();
                updateStats(null, time);
                statusText.textContent = '✓ JavaScript edge detection completed!';
            }, 10);
        });

        bothBtn.addEventListener('click', function() {
            if (!currentImage) return;
            statusText.textContent = 'Running comparison...';
            setTimeout(() => {
                const wasmTime = runWASMEdgeDetection();
                setTimeout(() => {
                    const jsTime = runJSEdgeDetection();
                    updateStats(wasmTime, jsTime);
                    statusText.textContent = '✓ Comparison completed!';
                }, 10);
            }, 10);
        });
    </script>
</body>
</html>
